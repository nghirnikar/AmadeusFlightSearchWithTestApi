<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flight Details</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: Arial, sans-serif; background:#f7f7f7; margin:0; padding:0; }
    .container { max-width:700px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 10px rgba(0,0,0,0.1); }
    h2 { color:#333; margin-top:0; }
    .btn { padding:10px 18px; border:none; border-radius:6px; cursor:pointer; margin-right:10px; font-weight:600; }
    .green { background:#28a745; color:#fff; }
    .red { background:#dc3545; color:#fff; }
    .yellow { background:#ffc107; color:#000; }
    pre { background:#f4f4f4; padding:10px; border-radius:8px; overflow-x:auto; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Selected Flight Details</h2>
    <div id="flightDetails">Loading...</div>
    <hr>
    <h3>Actions</h3>
    <button id="bookBtn" class="btn green">Book Now</button>
    <button id="cancelBtn" class="btn red">Cancel Order</button>
    <button id="payBtn" class="btn yellow">Simulate Payment</button>
    <div id="orderResult" style="margin-top:15px; font-size:14px;"></div>
  </div>

  <script>
    const API_BASE = "https://amadeus-proxy.nikhilcloudonline.workers.dev";
    const offer = JSON.parse(localStorage.getItem("selectedOffer") || "{}");

    const detailsDiv = document.getElementById("flightDetails");
    if (!offer.price) {
      detailsDiv.innerHTML = "<p style='color:red;'>No flight selected. Please go back and choose a flight.</p>";
    } else {
      const itin = offer.itineraries?.[0];
      const seg0 = itin?.segments?.[0];
      const last = itin?.segments?.[itin.segments.length-1];
      detailsDiv.innerHTML = `
        <p><b>${seg0?.departure?.iataCode}</b> → <b>${last?.arrival?.iataCode}</b> (${seg0?.carrierCode})</p>
        <p>${seg0?.departure?.at} → ${last?.arrival?.at}</p>
        <p><b>Duration:</b> ${(itin.duration||"").replace("PT","").toLowerCase()}</p>
        <p><b>Total:</b> ${offer.price.total} ${offer.price.currency}</p>
        <p><b>Traveler:</b> John Doe (demo)</p>
      `;
    }

    // ===== BOOK =====
    document.getElementById("bookBtn").addEventListener("click", async ()=>{
      const body = { offer, passenger:{firstName:"John",lastName:"Doe",email:"john@example.com",dob:"1990-01-01"} };
      const r = await fetch(`${API_BASE}/api/book`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(body)
      });
      const j = await r.json();
      if(r.ok && j.data?.id){
        window.lastOrderId = j.data.id;
        document.getElementById("orderResult").innerHTML = `<b>Booking created:</b> ${j.data.id}`;
      } else {
        document.getElementById("orderResult").innerHTML = `<b>Booking failed:</b> ${JSON.stringify(j)}`;
      }
    });

    // ===== CANCEL =====
    document.getElementById("cancelBtn").addEventListener("click", async ()=>{
      if(!window.lastOrderId) return alert("No order yet!");
      const r = await fetch(`${API_BASE}/api/cancel/${window.lastOrderId}`,{method:"DELETE"});
      const j = await r.json();
      document.getElementById("orderResult").innerHTML = `<b>Status:</b> ${j.status}`;
    });

    // ===== SIMULATE PAYMENT =====
    document.getElementById("payBtn").addEventListener("click", ()=>{
      const price = offer.price?.total;
      const curr = offer.price?.currency;
      document.getElementById("orderResult").innerHTML = `
        ✅ Payment successful! <br>Charged ${price} ${curr}<br>
        <b>Transaction ID:</b> PMT-${Math.random().toString(36).slice(2,10).toUpperCase()}`;
    });
  </script>
</body>
</html>
