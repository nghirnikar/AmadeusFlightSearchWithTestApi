<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flight Details & Booking</title>
  <link rel="stylesheet" href="style.css">
  <style>
    input {
      display: block;
      width: 100%;
      margin: 8px 0;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .btn {
      padding: 10px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      color: #fff;
      margin-top: 10px;
    }
    #bookBtn { background: #007bff; }
    #cancelBtn { background: #dc3545; }
  </style>
</head>
<body>
  <div class="container" id="flightDetails">
    <h2>Flight Details</h2>
    <div id="flightInfo"></div>

    <h3>Traveler Information</h3>
    <input id="fname" placeholder="First Name" required>
    <input id="lname" placeholder="Last Name" required>
    <input id="email" placeholder="Email" required>
    <label>Date of Birth:</label>
    <input id="dob" type="date" required>

    <button id="bookBtn" class="btn">Book Now</button>
    <button id="cancelBtn" class="btn">Cancel Booking</button>

    <div id="msg" style="margin-top:15px;"></div>
  </div>

  <script>
    // ============ CONFIG ============
    const API_BASE = "https://amadeus-proxy.nikhilcloudonline.workers.dev";
    const offer = JSON.parse(localStorage.getItem("selectedOffer") || "{}");
    const flightInfoDiv = document.getElementById("flightInfo");
    const msgDiv = document.getElementById("msg");

    // ============ DISPLAY SELECTED FLIGHT ============
    if (!offer.itineraries) {
      flightInfoDiv.innerHTML = "<p style='color:red;'>No flight selected.</p>";
    } else {
      const itin = offer.itineraries[0];
      const seg0 = itin.segments[0];
      const last = itin.segments[itin.segments.length - 1];
      const dep = seg0.departure.at.replace("T", " ");
      const arr = last.arrival.at.replace("T", " ");
      const price = offer.price.total + " " + offer.price.currency;

      flightInfoDiv.innerHTML = `
        <p><b>${seg0.departure.iataCode}</b> → <b>${last.arrival.iataCode}</b> (${seg0.carrierCode})</p>
        <p>${dep} → ${arr}</p>
        <p>Duration: ${itin.duration}</p>
        <p><b>Total Price:</b> ${price}</p>
      `;
    }

    // ============ BOOKING FUNCTION ============
    document.getElementById("bookBtn").onclick = async () => {
      const pax = {
        firstName: fname.value.trim(),
        lastName: lname.value.trim(),
        email: email.value.trim(),
        dob: dob.value.trim(),
      };

      if (!pax.firstName || !pax.lastName || !pax.email || !pax.dob) {
        msgDiv.innerHTML = "<p style='color:red;'>Please fill all traveler fields.</p>";
        return;
      }

      msgDiv.innerHTML = "<p>Processing booking...</p>";

      try {
        const res = await fetch(`${API_BASE}/api/book`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ offer, passenger: pax })
        });

        const text = await res.text();
        if (res.ok) {
          localStorage.setItem("selectedOffer", JSON.stringify(offer));
          msgDiv.innerHTML = "<p style='color:green;'>✅ Booking successful! Redirecting to payment...</p>";
          setTimeout(() => {
            window.location.href = "payment.html";
          }, 1500);
        } else {
          msgDiv.innerHTML = `<p style='color:red;'>Booking failed.<br>${text}</p>`;
        }
      } catch (err) {
        msgDiv.innerHTML = `<p style='color:red;'>Error: ${err.message}</p>`;
      }
    };

    // ============ CANCEL BOOKING (SIMULATED) ============
    document.getElementById("cancelBtn").onclick = async () => {
      msgDiv.innerHTML = "<p>Cancelling booking...</p>";
      await fetch(`${API_BASE}/api/cancel`, { method: "POST" });
      msgDiv.innerHTML = "<p style='color:red;'>Booking cancelled.</p>";
    };
  </script>
</body>
</html>
